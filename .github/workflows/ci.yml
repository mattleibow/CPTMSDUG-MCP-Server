name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 10 (when available)
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        dotnet-quality: 'preview'
      continue-on-error: true
      id: dotnet10
      
    - name: Setup .NET 9 (current latest)
      if: steps.dotnet10.outcome == 'failure'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Check .NET version and target framework compatibility
      run: |
        echo "Installed .NET version:"
        dotnet --version
        echo "Available SDKs:"
        dotnet --list-sdks
        echo ""
        if [[ "${{ steps.dotnet10.outcome }}" == "failure" ]]; then
          echo "âš ï¸  .NET 10 is not yet available. The projects target net10.0 but will need to be updated to use an available framework version."
          echo "ğŸ“‹ When .NET 10 becomes available, this pipeline will automatically use it."
        else
          echo "âœ… .NET 10 is available and ready to use."
        fi
        
    - name: Restore dependencies
      run: dotnet restore src/Cptmsdug.sln
      continue-on-error: true
      id: restore
      
    - name: Build solution
      if: steps.restore.outcome == 'success'
      run: dotnet build src/Cptmsdug.sln --configuration Release --no-restore
      continue-on-error: true
      id: build
      
    - name: Run tests
      if: steps.build.outcome == 'success'
      run: dotnet test src/Cptmsdug.Core.Tests/ --configuration Release --no-build --verbosity normal
      continue-on-error: true
      id: test
      
    - name: Pack .NET tool
      if: steps.build.outcome == 'success'
      run: dotnet pack src/Cptmsdug.McpServer/Cptmsdug.McpServer.csproj --configuration Release --no-build --output ./artifacts
      continue-on-error: true
      id: pack
      
    - name: Build status summary
      run: |
        echo "ğŸ“Š Build Pipeline Summary:"
        echo "========================"
        echo "ğŸ”§ Restore: ${{ steps.restore.outcome }}"
        echo "ğŸ—ï¸  Build:   ${{ steps.build.outcome }}"
        echo "ğŸ§ª Tests:   ${{ steps.test.outcome }}"
        echo "ğŸ“¦ Pack:    ${{ steps.pack.outcome }}"
        echo ""
        if [[ "${{ steps.restore.outcome }}" != "success" ]]; then
          echo "âŒ Build failed at restore step - likely due to .NET 10 target framework not being available yet."
          echo "ğŸ’¡ Once .NET 10 preview is released, this pipeline will work automatically."
          exit 1
        elif [[ "${{ steps.build.outcome }}" != "success" ]]; then
          echo "âŒ Build compilation failed."
          exit 1
        elif [[ "${{ steps.test.outcome }}" != "success" ]]; then
          echo "âŒ Tests failed."
          exit 1
        elif [[ "${{ steps.pack.outcome }}" != "success" ]]; then
          echo "âŒ Packaging failed."
          exit 1
        else
          echo "âœ… All steps completed successfully!"
        fi
      
    - name: Upload package artifacts
      if: steps.pack.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./artifacts/*.nupkg
        retention-days: 30